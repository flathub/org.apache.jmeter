app-id: org.apache.jmeter

runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk11

command: jmeter-wrapper.sh
finish-args:
  - --socket=x11
  - --share=ipc
  - --share=network
  - --persist=.java/.userPrefs
  - --filesystem=xdg-documents

add-extensions:
  org.apache.jmeter.Help:
    directory: docs
    bundle: true
    autodelete: true

modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk11/install.sh

  - name: JMeter
    buildsystem: simple
    build-commands:
      - cp -R bin lib /app/
      - install -Dpm755 -t /app/bin jmeter-wrapper.sh
      - install -Dpm644 -T docs/images/jmeter_square.png /app/share/icons/hicolor/256x256/apps/org.apache.jmeter.png
      - install -Dpm644 -T docs/images/jmeter_square.svg /app/share/icons/hicolor/scalable/apps/org.apache.jmeter.svg
      - install -Dpm644 -t /app/share/applications org.apache.jmeter.desktop
        # Copy User Manual
      - mv printable_docs/usermanual docs/
      - cp -R docs /app/
      - ln -s docs /app/printable_docs
    post-install:
      - install -Dpm644 -t /app/share/metainfo org.apache.jmeter.metainfo.xml
      - install -Dpm644 -t /app/docs/share/metainfo org.apache.jmeter.Help.metainfo.xml
      - appstream-compose --basename=org.apache.jmeter.Help --prefix=/app/docs --origin=flatpak org.apache.jmeter.Help
    cleanup:
      - /bin/*.bat
      - /bin/*.cmd
      - /bin/*.bshrc
      - /bin/examples
        # Clean docs
      - /docs/.htaccess
      - /docs/api
      - /docs/images/favicon.*
      - /docs/images/apple-touch-icon.png
      - /docs/images/mstile-*.png
      - /docs/images/jmeter_square.*
      - /docs/images/screenshoots/changes
      - /docs/usermanual/*.pdf
    sources:
      - type: archive
        url: https://dlcdn.apache.org//jmeter/binaries/apache-jmeter-5.6.2.tgz
        sha256: 08696d3b6278d272342d18609e2167ef28d2d1d5f71b592809c00bbd57cc8ef0
        x-checker-data:
          type: html
          url: https://jmeter.apache.org/download_jmeter.cgi
          pattern: <a href="(https://dlcdn.apache.org//?jmeter/binaries/apache-jmeter-([^/]+).tgz)">
      - type: file
        path: jmeter-wrapper.sh
      - type: file
        path: org.apache.jmeter.desktop
      - type: file
        path: org.apache.jmeter.metainfo.xml
      - type: file
        path: org.apache.jmeter.Help.metainfo.xml
